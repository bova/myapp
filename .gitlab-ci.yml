stages:
  - image-build
  - deploy

#job name    
image-build:
  stage: image-build
  image: docker:latest
  tags:
    - docker-executor
  before_script:
    - echo $CI_REGISTRY_USER
    - ls -lh; hostname; pwd
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD  docker.io
##    - docker login gitlab.bova-vp.ru:5050
  script:        
    - unset DOCKER_HOST
    - docker build -t vpovetkin/myapp:$IMAGE_TAG .
    - docker push vpovetkin/myapp:$IMAGE_TAG
##    - docker build -t gitlab.bova-vp.ru:5050/root/myapp .
##    - docker push gitlab.bova-vp.ru:5050/root/myapp
  rules:
    - if: $CI_COMMIT_TAG == null
      variables:
        IMAGE_TAG: 'latest'
    - when: always
      variables:
        IMAGE_TAG: $CI_COMMIT_TAG

deploy-dev:
  stage: deploy
  image:
    name: quay.io/appuio/oc:v4.12
    entrypoint: ['']
  before_script:
    - echo $IMAGE
    - echo $CI_API_V4_URL
    - echo $CONFIG_ACCESS_TOKEN
  script:
    - 'curl -v --insecure --header "PRIVATE-TOKEN: $CONFIG_ACCESS_TOKEN" "$CI_API_V4_URL/projects/1/repository/files/deployment%2Eyml/raw?ref=main" > deployment.yml'
    - sed -i "s~{IMAGE}~$IMAGE~g" deployment.yml
    - cat deployment.yml

    - kubectl config use-context root/myapp:mydev
    - kubectl config get-contexts
    - kubectl get pods
##    - kubectl delete deployment myapp -n mydev-ns
    - kubectl apply -f deployment.yml -n mydev-ns
  rules:
##    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG != null
  tags:
      - docker-executor    